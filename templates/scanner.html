{% extends "base.html" %}

{% block title %}Scanner QR Code{% endblock %}

{% block content %}
<div class="container">
    <h2>Votre QR Code Wallet</h2>

    <div class="qr-container">
        <div id="qr-code" class="qr-code"></div>
        <div class="input-group">
            <label for="wallet-address">Adresse du Wallet :</label>
            <input type="text" id="wallet-address" placeholder="Entrez votre adresse du wallet">
            <button class="btn btn-green" onclick="generateQRCode()">Générer le QR Code</button>
        </div>
    </div>

    <h3>Scanner l'adresse du destinataire</h3>
    <button id="scan-btn" class="btn btn-orange">Ouvrir la caméra</button>
    
    <div id="scanner-container" class="hidden"></div>
    <div id="qr-result" class="qr-result hidden"></div>
    <p id="error-message" class="error-message"></p>

    <a href="{{ url_for('index') }}" class="btn btn-green">Retour à l'accueil</a>
</div>

<!-- Bibliothèques QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
    function generateQRCode() {
        let walletAddress = document.getElementById('wallet-address').value;
        if (walletAddress) {
            document.getElementById("qr-code").innerHTML = "";
            new QRCode(document.getElementById("qr-code"), {
                text: walletAddress,
                width: 150,
                height: 150
            });
        } else {
            alert('Veuillez entrer une adresse de wallet.');
        }
    }

    document.getElementById('scan-btn').addEventListener('click', function () {
        let scannerContainer = document.getElementById("scanner-container");
        let errorMessage = document.getElementById("error-message");
        let qrResult = document.getElementById("qr-result");

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            errorMessage.innerText = "Erreur : votre navigateur ne supporte pas l'accès à la caméra.";
            return;
        }

        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                let videoDevices = devices.filter(device => device.kind === "videoinput");
                if (videoDevices.length === 0) {
                    errorMessage.innerText = "Erreur : Aucune caméra détectée.";
                    return;
                }

                scannerContainer.classList.remove("hidden");
                scannerContainer.innerHTML = "";

                const html5QrCode = new Html5Qrcode("scanner-container");

                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    qrCodeMessage => {
                        qrResult.classList.remove("hidden");
                        qrResult.innerText = "Adresse du destinataire : " + qrCodeMessage;
                        html5QrCode.stop();
                    },
                    error => {
                        console.warn("Erreur de scan : ", error);
                    }
                ).catch(err => {
                    errorMessage.innerText = "Impossible d'ouvrir la caméra : " + err;
                });
            })
            .catch(err => {
                errorMessage.innerText = "Erreur lors de la détection des appareils : " + err;
            });
    });
</script>


{% endblock %}
